<!DOCTYPE html>
<!-- MIT License

Copyright (c) 2017 Pavel Dobryakov

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE. -->
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>WebGL Fluid Simulation</title>
<style>
html, body {
  overflow: hidden;
  background-color: #000;
}
body {
  margin: 0;
  position: fixed;
  width: 100%;
  height: 100%;
}
canvas {
  width: 100%;
  height: 100%;
}
.promo {
  position: fixed;
  font-size: 28px;
  bottom: 7px;
  right: 7px;
  color: #fff;
}
</style>
</head>
<body>
<canvas></canvas>
<!-- awesome sauce -->
<a class="promo" href="https://paveldogreat.github.io/WebGL-Fluid-Simulation/">
paveldogreat.github.io/WebGL-Fluid-Simulation
</a>
<img src onerror='
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(a){return a.raw=a};$jscomp.createTemplateTagFirstArgWithRaw=function(a,b){a.raw=b;return a};var canvas=document.getElementsByTagName("canvas")[0];resizeCanvas();
var config={SIM_RESOLUTION:128,DYE_RESOLUTION:512,CAPTURE_RESOLUTION:512,DENSITY_DISSIPATION:1,VELOCITY_DISSIPATION:.2,PRESSURE:.8,PRESSURE_ITERATIONS:20,CURL:30,SPLAT_RADIUS:.25,SPLAT_FORCE:6E3,SHADING:!0,COLORFUL:!0,COLOR_UPDATE_SPEED:10,PAUSED:!1,BACK_COLOR:{r:0,g:0,b:0},TRANSPARENT:!1,BLOOM:!0,BLOOM_ITERATIONS:8,BLOOM_RESOLUTION:256,BLOOM_INTENSITY:.8,BLOOM_THRESHOLD:.6,BLOOM_SOFT_KNEE:.7,SUNRAYS:!0,SUNRAYS_RESOLUTION:196,SUNRAYS_WEIGHT:1};
function pointerPrototype(){this.id=-1;this.deltaY=this.deltaX=this.prevTexcoordY=this.prevTexcoordX=this.texcoordY=this.texcoordX=0;this.moved=this.down=!1;this.color=[30,0,300]}var pointers=[],splatStack=[];pointers.push(new pointerPrototype);var $jscomp$destructuring$var0=getWebGLContext(canvas),gl=$jscomp$destructuring$var0.gl,ext=$jscomp$destructuring$var0.ext;
function getWebGLContext(a){a=a.getContext("webgl",{alpha:!0,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!1});var b=a.getExtension("OES_texture_half_float"),c=a.getExtension("OES_texture_half_float_linear");a.clearColor(0,0,0,1);b=b.HALF_FLOAT_OES;var d=getSupportedFormat(a,a.RGBA,a.RGBA,b),e=getSupportedFormat(a,a.RGBA,a.RGBA,b),g=getSupportedFormat(a,a.RGBA,a.RGBA,b);return{gl:a,ext:{formatRGBA:d,formatRG:e,formatR:g,halfFloatTexType:b,supportLinearFiltering:c}}}
function getSupportedFormat(a,b,c,d){if(!supportRenderTextureFormat(a,b,c,d))switch(b){case a.R16F:return getSupportedFormat(a,a.RG16F,a.RG,d);case a.RG16F:return getSupportedFormat(a,a.RGBA16F,a.RGBA,d);default:return null}return{internalFormat:b,format:c}}
function supportRenderTextureFormat(a,b,c,d){var e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texImage2D(a.TEXTURE_2D,0,b,4,4,0,c,d,null);b=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,b);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,
a.TEXTURE_2D,e,0);return a.checkFramebufferStatus(a.FRAMEBUFFER)==a.FRAMEBUFFER_COMPLETE}function framebufferToTexture(a){gl.bindFramebuffer(gl.FRAMEBUFFER,a.fbo);var b=new Float32Array(a.width*a.height*4);gl.readPixels(0,0,a.width,a.height,gl.RGBA,gl.FLOAT,b);return b}
function normalizeTexture(a,b,c){var d=new Uint8Array(a.length),e=0;for(--c;0<=c;c--)for(var g=0;g<b;g++){var f=c*b*4+4*g;d[f+0]=255*clamp01(a[e+0]);d[f+1]=255*clamp01(a[e+1]);d[f+2]=255*clamp01(a[e+2]);d[f+3]=255*clamp01(a[e+3]);e+=4}return d}function clamp01(a){return Math.min(Math.max(a,0),1)}function textureToCanvas(a,b,c){var d=document.createElement("canvas"),e=d.getContext("2d");d.width=b;d.height=c;b=e.createImageData(b,c);b.data.set(a);e.putImageData(b,0,0);return d}
var Material=function(a,b){this.vertexShader=a;this.fragmentShaderSource=b;this.programs=[];this.activeProgram=null;this.uniforms=[]};Material.prototype.setKeywords=function(a){for(var b=0,c=0;c<a.length;c++)b+=hashCode(a[c]);c=this.programs[b];null==c&&(a=compileShader(gl.FRAGMENT_SHADER,this.fragmentShaderSource,a),c=createProgram(this.vertexShader,a),this.programs[b]=c);c!=this.activeProgram&&(this.uniforms=getUniforms(c),this.activeProgram=c)};Material.prototype.bind=function(){gl.useProgram(this.activeProgram)};
var Program=function(a,b){this.uniforms={};this.program=createProgram(a,b);this.uniforms=getUniforms(this.program)};Program.prototype.bind=function(){gl.useProgram(this.program)};function createProgram(a,b){var c=gl.createProgram();gl.attachShader(c,a);gl.attachShader(c,b);gl.linkProgram(c);gl.getProgramParameter(c,gl.LINK_STATUS)||console.trace(gl.getProgramInfoLog(c));return c}
function getUniforms(a){for(var b=[],c=gl.getProgramParameter(a,gl.ACTIVE_UNIFORMS),d=0;d<c;d++){var e=gl.getActiveUniform(a,d).name;b[e]=gl.getUniformLocation(a,e)}return b}function compileShader(a,b,c){b=addKeywords(b,c);a=gl.createShader(a);gl.shaderSource(a,b);gl.compileShader(a);gl.getShaderParameter(a,gl.COMPILE_STATUS)||console.trace(gl.getShaderInfoLog(a));return a}function addKeywords(a,b){if(null==b)return a;var c="";b.forEach(function(d){c+="#define "+d+"\n"});return c+a}
var baseVertexShader=compileShader(gl.VERTEX_SHADER,"\n    precision highp float;\n\n    attribute vec2 aPosition;\n    varying vec2 vUv;\n    varying vec2 vL;\n    varying vec2 vR;\n    varying vec2 vT;\n    varying vec2 vB;\n    uniform vec2 texelSize;\n\n    void main () {\n        vUv = aPosition * 0.5 + 0.5;\n        vL = vUv - vec2(texelSize.x, 0.0);\n        vR = vUv + vec2(texelSize.x, 0.0);\n        vT = vUv + vec2(0.0, texelSize.y);\n        vB = vUv - vec2(0.0, texelSize.y);\n        gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n"),
blurVertexShader=compileShader(gl.VERTEX_SHADER,"\n    precision highp float;\n\n    attribute vec2 aPosition;\n    varying vec2 vUv;\n    varying vec2 vL;\n    varying vec2 vR;\n    uniform vec2 texelSize;\n\n    void main () {\n        vUv = aPosition * 0.5 + 0.5;\n        float offset = 1.33333333;\n        vL = vUv - texelSize * offset;\n        vR = vUv + texelSize * offset;\n        gl_Position = vec4(aPosition, 0.0, 1.0);\n    }\n"),blurShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying vec2 vUv;\n    varying vec2 vL;\n    varying vec2 vR;\n    uniform sampler2D uTexture;\n\n    void main () {\n        vec4 sum = texture2D(uTexture, vUv) * 0.29411764;\n        sum += texture2D(uTexture, vL) * 0.35294117;\n        sum += texture2D(uTexture, vR) * 0.35294117;\n        gl_FragColor = sum;\n    }\n"),
copyShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying highp vec2 vUv;\n    uniform sampler2D uTexture;\n\n    void main () {\n        gl_FragColor = texture2D(uTexture, vUv);\n    }\n"),clearShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying highp vec2 vUv;\n    uniform sampler2D uTexture;\n    uniform float value;\n\n    void main () {\n        gl_FragColor = value * texture2D(uTexture, vUv);\n    }\n"),
colorShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n\n    uniform vec4 color;\n\n    void main () {\n        gl_FragColor = color;\n    }\n"),checkerboardShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision highp float;\n    precision highp sampler2D;\n\n    varying vec2 vUv;\n    uniform sampler2D uTexture;\n    uniform float aspectRatio;\n\n    #define SCALE 25.0\n\n    void main () {\n        vec2 uv = floor(vUv * SCALE * vec2(aspectRatio, 1.0));\n        float v = mod(uv.x + uv.y, 2.0);\n        v = v * 0.1 + 0.8;\n        gl_FragColor = vec4(vec3(v), 1.0);\n    }\n"),
displayShaderSource="\n    precision highp float;\n    precision highp sampler2D;\n\n    varying vec2 vUv;\n    varying vec2 vL;\n    varying vec2 vR;\n    varying vec2 vT;\n    varying vec2 vB;\n    uniform sampler2D uTexture;\n    uniform sampler2D uBloom;\n    uniform sampler2D uSunrays;\n    uniform sampler2D uDithering;\n    uniform vec2 ditherScale;\n    uniform vec2 texelSize;\n\n    vec3 linearToGamma (vec3 color) {\n        color = max(color, vec3(0));\n        return max(1.055 * pow(color, vec3(0.416666667)) - 0.055, vec3(0));\n    }\n\n    void main () {\n        vec3 c = texture2D(uTexture, vUv).rgb;\n\n    #ifdef SHADING\n        vec3 lc = texture2D(uTexture, vL).rgb;\n        vec3 rc = texture2D(uTexture, vR).rgb;\n        vec3 tc = texture2D(uTexture, vT).rgb;\n        vec3 bc = texture2D(uTexture, vB).rgb;\n\n        float dx = length(rc) - length(lc);\n        float dy = length(tc) - length(bc);\n\n        vec3 n = normalize(vec3(dx, dy, length(texelSize)));\n        vec3 l = vec3(0.0, 0.0, 1.0);\n\n        float diffuse = clamp(dot(n, l) + 0.7, 0.7, 1.0);\n        c *= diffuse;\n    #endif\n\n    #ifdef BLOOM\n        vec3 bloom = texture2D(uBloom, vUv).rgb;\n    #endif\n\n    #ifdef SUNRAYS\n        float sunrays = texture2D(uSunrays, vUv).r;\n        c *= sunrays;\n    #ifdef BLOOM\n        bloom *= sunrays;\n    #endif\n    #endif\n\n    #ifdef BLOOM\n        float noise = texture2D(uDithering, vUv * ditherScale).r;\n        noise = noise * 2.0 - 1.0;\n        bloom += noise / 255.0;\n        bloom = linearToGamma(bloom);\n        c += bloom;\n    #endif\n\n        float a = max(c.r, max(c.g, c.b));\n        gl_FragColor = vec4(c, a);\n    }\n",
bloomPrefilterShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying vec2 vUv;\n    uniform sampler2D uTexture;\n    uniform vec3 curve;\n    uniform float threshold;\n\n    void main () {\n        vec3 c = texture2D(uTexture, vUv).rgb;\n        float br = max(c.r, max(c.g, c.b));\n        float rq = clamp(br - curve.x, 0.0, curve.y);\n        rq = curve.z * rq * rq;\n        c *= max(rq, br - threshold) / max(br, 0.0001);\n        gl_FragColor = vec4(c, 0.0);\n    }\n"),
bloomBlurShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying vec2 vL;\n    varying vec2 vR;\n    varying vec2 vT;\n    varying vec2 vB;\n    uniform sampler2D uTexture;\n\n    void main () {\n        vec4 sum = vec4(0.0);\n        sum += texture2D(uTexture, vL);\n        sum += texture2D(uTexture, vR);\n        sum += texture2D(uTexture, vT);\n        sum += texture2D(uTexture, vB);\n        sum *= 0.25;\n        gl_FragColor = sum;\n    }\n"),
bloomFinalShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying vec2 vL;\n    varying vec2 vR;\n    varying vec2 vT;\n    varying vec2 vB;\n    uniform sampler2D uTexture;\n    uniform float intensity;\n\n    void main () {\n        vec4 sum = vec4(0.0);\n        sum += texture2D(uTexture, vL);\n        sum += texture2D(uTexture, vR);\n        sum += texture2D(uTexture, vT);\n        sum += texture2D(uTexture, vB);\n        sum *= 0.25;\n        gl_FragColor = sum * intensity;\n    }\n"),
sunraysMaskShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision highp float;\n    precision highp sampler2D;\n\n    varying vec2 vUv;\n    uniform sampler2D uTexture;\n\n    void main () {\n        vec4 c = texture2D(uTexture, vUv);\n        float br = max(c.r, max(c.g, c.b));\n        c.a = 1.0 - min(max(br * 20.0, 0.0), 0.8);\n        gl_FragColor = c;\n    }\n"),sunraysShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision highp float;\n    precision highp sampler2D;\n\n    varying vec2 vUv;\n    uniform sampler2D uTexture;\n    uniform float weight;\n\n    #define ITERATIONS 16\n\n    void main () {\n        float Density = 0.3;\n        float Decay = 0.95;\n        float Exposure = 0.7;\n\n        vec2 coord = vUv;\n        vec2 dir = vUv - 0.5;\n\n        dir *= 1.0 / float(ITERATIONS) * Density;\n        float illuminationDecay = 1.0;\n\n        float color = texture2D(uTexture, vUv).a;\n\n        for (int i = 0; i < ITERATIONS; i++)\n        {\n            coord -= dir;\n            float col = texture2D(uTexture, coord).a;\n            color += col * illuminationDecay * weight;\n            illuminationDecay *= Decay;\n        }\n\n        gl_FragColor = vec4(color * Exposure, 0.0, 0.0, 1.0);\n    }\n"),
splatShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision highp float;\n    precision highp sampler2D;\n\n    varying vec2 vUv;\n    uniform sampler2D uTarget;\n    uniform float aspectRatio;\n    uniform vec3 color;\n    uniform vec2 point;\n    uniform float radius;\n\n    void main () {\n        vec2 p = vUv - point.xy;\n        p.x *= aspectRatio;\n        vec3 splat = exp(-dot(p, p) / radius) * color;\n        vec3 base = texture2D(uTarget, vUv).xyz;\n        gl_FragColor = vec4(base + splat, 1.0);\n    }\n"),
advectionShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision highp float;\n    precision highp sampler2D;\n\n    varying vec2 vUv;\n    uniform sampler2D uVelocity;\n    uniform sampler2D uSource;\n    uniform vec2 texelSize;\n    uniform vec2 dyeTexelSize;\n    uniform float dt;\n    uniform float dissipation;\n\n    vec4 bilerp (sampler2D sam, vec2 uv, vec2 tsize) {\n        vec2 st = uv / tsize - 0.5;\n\n        vec2 iuv = floor(st);\n        vec2 fuv = fract(st);\n\n        vec4 a = texture2D(sam, (iuv + vec2(0.5, 0.5)) * tsize);\n        vec4 b = texture2D(sam, (iuv + vec2(1.5, 0.5)) * tsize);\n        vec4 c = texture2D(sam, (iuv + vec2(0.5, 1.5)) * tsize);\n        vec4 d = texture2D(sam, (iuv + vec2(1.5, 1.5)) * tsize);\n\n        return mix(mix(a, b, fuv.x), mix(c, d, fuv.x), fuv.y);\n    }\n\n    void main () {\n    #ifdef MANUAL_FILTERING\n        vec2 coord = vUv - dt * bilerp(uVelocity, vUv, texelSize).xy * texelSize;\n        vec4 result = bilerp(uSource, coord, dyeTexelSize);\n    #else\n        vec2 coord = vUv - dt * texture2D(uVelocity, vUv).xy * texelSize;\n        vec4 result = texture2D(uSource, coord);\n    #endif\n        float decay = 1.0 + dissipation * dt;\n        gl_FragColor = result / decay;\n    }",
ext.supportLinearFiltering?null:["MANUAL_FILTERING"]),divergenceShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying highp vec2 vUv;\n    varying highp vec2 vL;\n    varying highp vec2 vR;\n    varying highp vec2 vT;\n    varying highp vec2 vB;\n    uniform sampler2D uVelocity;\n\n    void main () {\n        float L = texture2D(uVelocity, vL).x;\n        float R = texture2D(uVelocity, vR).x;\n        float T = texture2D(uVelocity, vT).y;\n        float B = texture2D(uVelocity, vB).y;\n\n        vec2 C = texture2D(uVelocity, vUv).xy;\n        if (vL.x < 0.0) { L = -C.x; }\n        if (vR.x > 1.0) { R = -C.x; }\n        if (vT.y > 1.0) { T = -C.y; }\n        if (vB.y < 0.0) { B = -C.y; }\n\n        float div = 0.5 * (R - L + T - B);\n        gl_FragColor = vec4(div, 0.0, 0.0, 1.0);\n    }\n"),
curlShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying highp vec2 vUv;\n    varying highp vec2 vL;\n    varying highp vec2 vR;\n    varying highp vec2 vT;\n    varying highp vec2 vB;\n    uniform sampler2D uVelocity;\n\n    void main () {\n        float L = texture2D(uVelocity, vL).y;\n        float R = texture2D(uVelocity, vR).y;\n        float T = texture2D(uVelocity, vT).x;\n        float B = texture2D(uVelocity, vB).x;\n        float vorticity = R - L - T + B;\n        gl_FragColor = vec4(0.5 * vorticity, 0.0, 0.0, 1.0);\n    }\n"),
vorticityShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision highp float;\n    precision highp sampler2D;\n\n    varying vec2 vUv;\n    varying vec2 vL;\n    varying vec2 vR;\n    varying vec2 vT;\n    varying vec2 vB;\n    uniform sampler2D uVelocity;\n    uniform sampler2D uCurl;\n    uniform float curl;\n    uniform float dt;\n\n    void main () {\n        float L = texture2D(uCurl, vL).x;\n        float R = texture2D(uCurl, vR).x;\n        float T = texture2D(uCurl, vT).x;\n        float B = texture2D(uCurl, vB).x;\n        float C = texture2D(uCurl, vUv).x;\n\n        vec2 force = 0.5 * vec2(abs(T) - abs(B), abs(R) - abs(L));\n        force /= length(force) + 0.0001;\n        force *= curl * C;\n        force.y *= -1.0;\n\n        vec2 velocity = texture2D(uVelocity, vUv).xy;\n        velocity += force * dt;\n        velocity = min(max(velocity, -1000.0), 1000.0);\n        gl_FragColor = vec4(velocity, 0.0, 1.0);\n    }\n"),
pressureShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying highp vec2 vUv;\n    varying highp vec2 vL;\n    varying highp vec2 vR;\n    varying highp vec2 vT;\n    varying highp vec2 vB;\n    uniform sampler2D uPressure;\n    uniform sampler2D uDivergence;\n\n    void main () {\n        float L = texture2D(uPressure, vL).x;\n        float R = texture2D(uPressure, vR).x;\n        float T = texture2D(uPressure, vT).x;\n        float B = texture2D(uPressure, vB).x;\n        float C = texture2D(uPressure, vUv).x;\n        float divergence = texture2D(uDivergence, vUv).x;\n        float pressure = (L + R + B + T - divergence) * 0.25;\n        gl_FragColor = vec4(pressure, 0.0, 0.0, 1.0);\n    }\n"),
gradientSubtractShader=compileShader(gl.FRAGMENT_SHADER,"\n    precision mediump float;\n    precision mediump sampler2D;\n\n    varying highp vec2 vUv;\n    varying highp vec2 vL;\n    varying highp vec2 vR;\n    varying highp vec2 vT;\n    varying highp vec2 vB;\n    uniform sampler2D uPressure;\n    uniform sampler2D uVelocity;\n\n    void main () {\n        float L = texture2D(uPressure, vL).x;\n        float R = texture2D(uPressure, vR).x;\n        float T = texture2D(uPressure, vT).x;\n        float B = texture2D(uPressure, vB).x;\n        vec2 velocity = texture2D(uVelocity, vUv).xy;\n        velocity.xy -= vec2(R - L, T - B);\n        gl_FragColor = vec4(velocity, 0.0, 1.0);\n    }\n"),
blit=function(){gl.bindBuffer(gl.ARRAY_BUFFER,gl.createBuffer());gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,-1,1,1,1,1,-1]),gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,gl.createBuffer());gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),gl.STATIC_DRAW);gl.vertexAttribPointer(0,2,gl.FLOAT,!1,0,0);gl.enableVertexAttribArray(0);return function(a,b){b=void 0===b?!1:b;null==a?(gl.viewport(0,0,gl.drawingBufferWidth,gl.drawingBufferHeight),gl.bindFramebuffer(gl.FRAMEBUFFER,
null)):(gl.viewport(0,0,a.width,a.height),gl.bindFramebuffer(gl.FRAMEBUFFER,a.fbo));b&&(gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT));gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0)}}();function CHECK_FRAMEBUFFER_STATUS(){var a=gl.checkFramebufferStatus(gl.FRAMEBUFFER);a!=gl.FRAMEBUFFER_COMPLETE&&console.trace("Framebuffer error: "+a)}
var dye,velocity,divergence,curl,pressure,bloom,bloomFramebuffers=[],sunrays,sunraysTemp,ditheringTexture=createTextureAsync("LDR_LLL1_0.png"),blurProgram=new Program(blurVertexShader,blurShader),copyProgram=new Program(baseVertexShader,copyShader),clearProgram=new Program(baseVertexShader,clearShader),colorProgram=new Program(baseVertexShader,colorShader),checkerboardProgram=new Program(baseVertexShader,checkerboardShader),bloomPrefilterProgram=new Program(baseVertexShader,bloomPrefilterShader),
bloomBlurProgram=new Program(baseVertexShader,bloomBlurShader),bloomFinalProgram=new Program(baseVertexShader,bloomFinalShader),sunraysMaskProgram=new Program(baseVertexShader,sunraysMaskShader),sunraysProgram=new Program(baseVertexShader,sunraysShader),splatProgram=new Program(baseVertexShader,splatShader),advectionProgram=new Program(baseVertexShader,advectionShader),divergenceProgram=new Program(baseVertexShader,divergenceShader),curlProgram=new Program(baseVertexShader,curlShader),vorticityProgram=
new Program(baseVertexShader,vorticityShader),pressureProgram=new Program(baseVertexShader,pressureShader),gradienSubtractProgram=new Program(baseVertexShader,gradientSubtractShader),displayMaterial=new Material(baseVertexShader,displayShaderSource);
function initFramebuffers(){var a=getResolution(config.SIM_RESOLUTION),b=getResolution(config.DYE_RESOLUTION),c=ext.halfFloatTexType,d=ext.formatRGBA,e=ext.formatRG,g=ext.formatR,f=ext.supportLinearFiltering?gl.LINEAR:gl.NEAREST;gl.disable(gl.BLEND);dye=null==dye?createDoubleFBO(b.width,b.height,d.internalFormat,d.format,c,f):resizeDoubleFBO(dye,b.width,b.height,d.internalFormat,d.format,c,f);velocity=null==velocity?createDoubleFBO(a.width,a.height,e.internalFormat,e.format,c,f):resizeDoubleFBO(velocity,
a.width,a.height,e.internalFormat,e.format,c,f);divergence=createFBO(a.width,a.height,g.internalFormat,g.format,c,gl.NEAREST);curl=createFBO(a.width,a.height,g.internalFormat,g.format,c,gl.NEAREST);pressure=createDoubleFBO(a.width,a.height,g.internalFormat,g.format,c,gl.NEAREST);initBloomFramebuffers();initSunraysFramebuffers()}
function initBloomFramebuffers(){var a=getResolution(config.BLOOM_RESOLUTION),b=ext.halfFloatTexType,c=ext.formatRGBA,d=ext.supportLinearFiltering?gl.LINEAR:gl.NEAREST;bloom=createFBO(a.width,a.height,c.internalFormat,c.format,b,d);for(var e=bloomFramebuffers.length=0;e<config.BLOOM_ITERATIONS;e++){var g=a.width>>e+1,f=a.height>>e+1;if(2>g||2>f)break;g=createFBO(g,f,c.internalFormat,c.format,b,d);bloomFramebuffers.push(g)}}
function initSunraysFramebuffers(){var a=getResolution(config.SUNRAYS_RESOLUTION),b=ext.halfFloatTexType,c=ext.formatR,d=ext.supportLinearFiltering?gl.LINEAR:gl.NEAREST;sunrays=createFBO(a.width,a.height,c.internalFormat,c.format,b,d);sunraysTemp=createFBO(a.width,a.height,c.internalFormat,c.format,b,d)}
function createFBO(a,b,c,d,e,g){gl.activeTexture(gl.TEXTURE0);var f=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,f);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,g);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,g);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,c,a,b,0,d,e,null);c=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,c);gl.framebufferTexture2D(gl.FRAMEBUFFER,
gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,f,0);gl.viewport(0,0,a,b);gl.clear(gl.COLOR_BUFFER_BIT);return{texture:f,fbo:c,width:a,height:b,texelSizeX:1/a,texelSizeY:1/b,attach:function(h){gl.activeTexture(gl.TEXTURE0+h);gl.bindTexture(gl.TEXTURE_2D,f);return h}}}function createDoubleFBO(a,b,c,d,e,g){var f=createFBO(a,b,c,d,e,g);c=createFBO(a,b,c,d,e,g);var h={width:a,height:b,texelSizeX:f.texelSizeX,texelSizeY:f.texelSizeY,read:f,write:c,swap:function(){var k=h.read;h.read=h.write;h.write=k}};return h}
function resizeFBO(a,b,c,d,e,g,f){b=createFBO(b,c,d,e,g,f);copyProgram.bind();gl.uniform1i(copyProgram.uniforms.uTexture,a.attach(0));blit(b);return b}function resizeDoubleFBO(a,b,c,d,e,g,f){if(a.width==b&&a.height==c)return a;a.read=resizeFBO(a.read,b,c,d,e,g,f);a.write=createFBO(b,c,d,e,g,f);a.width=b;a.height=c;a.texelSizeX=1/b;a.texelSizeY=1/c;return a}
function createTextureAsync(a){var b=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,b);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,1,1,0,gl.RGB,gl.UNSIGNED_BYTE,new Uint8Array([255,255,255]));var c={texture:b,width:1,height:1,attach:function(e){gl.activeTexture(gl.TEXTURE0+
e);gl.bindTexture(gl.TEXTURE_2D,b);return e}},d=new Image;d.onload=function(){c.width=d.width;c.height=d.height;gl.bindTexture(gl.TEXTURE_2D,b);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGB,gl.RGB,gl.UNSIGNED_BYTE,d)};d.src=a;return c}function updateKeywords(){var a=[];config.SHADING&&a.push("SHADING");config.BLOOM&&a.push("BLOOM");config.SUNRAYS&&a.push("SUNRAYS");displayMaterial.setKeywords(a)}updateKeywords();initFramebuffers();multipleSplats(parseInt(20*Math.random())+5);
var lastUpdateTime=Date.now(),colorUpdateTimer=0;update();function update(){var a=calcDeltaTime();resizeCanvas()&&initFramebuffers();updateColors(a);applyInputs();config.PAUSED||step(a);render(null);requestAnimationFrame(update)}function calcDeltaTime(){var a=Date.now(),b=(a-lastUpdateTime)/1E3;b=Math.min(b,.016666);lastUpdateTime=a;return b}
function resizeCanvas(){var a=scaleByPixelRatio(canvas.clientWidth),b=scaleByPixelRatio(canvas.clientHeight);return canvas.width!=a||canvas.height!=b?(canvas.width=a,canvas.height=b,!0):!1}function updateColors(a){config.COLORFUL&&(colorUpdateTimer+=a*config.COLOR_UPDATE_SPEED,1<=colorUpdateTimer&&(colorUpdateTimer=wrap(colorUpdateTimer,0,1),pointers.forEach(function(b){b.color=generateColor()})))}
function applyInputs(){0<splatStack.length&&multipleSplats(splatStack.pop());pointers.forEach(function(a){a.moved&&(a.moved=!1,splatPointer(a))})}
function step(a){gl.disable(gl.BLEND);curlProgram.bind();gl.uniform2f(curlProgram.uniforms.texelSize,velocity.texelSizeX,velocity.texelSizeY);gl.uniform1i(curlProgram.uniforms.uVelocity,velocity.read.attach(0));blit(curl);vorticityProgram.bind();gl.uniform2f(vorticityProgram.uniforms.texelSize,velocity.texelSizeX,velocity.texelSizeY);gl.uniform1i(vorticityProgram.uniforms.uVelocity,velocity.read.attach(0));gl.uniform1i(vorticityProgram.uniforms.uCurl,curl.attach(1));gl.uniform1f(vorticityProgram.uniforms.curl,
config.CURL);gl.uniform1f(vorticityProgram.uniforms.dt,a);blit(velocity.write);velocity.swap();divergenceProgram.bind();gl.uniform2f(divergenceProgram.uniforms.texelSize,velocity.texelSizeX,velocity.texelSizeY);gl.uniform1i(divergenceProgram.uniforms.uVelocity,velocity.read.attach(0));blit(divergence);clearProgram.bind();gl.uniform1i(clearProgram.uniforms.uTexture,pressure.read.attach(0));gl.uniform1f(clearProgram.uniforms.value,config.PRESSURE);blit(pressure.write);pressure.swap();pressureProgram.bind();
gl.uniform2f(pressureProgram.uniforms.texelSize,velocity.texelSizeX,velocity.texelSizeY);gl.uniform1i(pressureProgram.uniforms.uDivergence,divergence.attach(0));for(var b=0;b<config.PRESSURE_ITERATIONS;b++)gl.uniform1i(pressureProgram.uniforms.uPressure,pressure.read.attach(1)),blit(pressure.write),pressure.swap();gradienSubtractProgram.bind();gl.uniform2f(gradienSubtractProgram.uniforms.texelSize,velocity.texelSizeX,velocity.texelSizeY);gl.uniform1i(gradienSubtractProgram.uniforms.uPressure,pressure.read.attach(0));
gl.uniform1i(gradienSubtractProgram.uniforms.uVelocity,velocity.read.attach(1));blit(velocity.write);velocity.swap();advectionProgram.bind();gl.uniform2f(advectionProgram.uniforms.texelSize,velocity.texelSizeX,velocity.texelSizeY);ext.supportLinearFiltering||gl.uniform2f(advectionProgram.uniforms.dyeTexelSize,velocity.texelSizeX,velocity.texelSizeY);b=velocity.read.attach(0);gl.uniform1i(advectionProgram.uniforms.uVelocity,b);gl.uniform1i(advectionProgram.uniforms.uSource,b);gl.uniform1f(advectionProgram.uniforms.dt,
a);gl.uniform1f(advectionProgram.uniforms.dissipation,config.VELOCITY_DISSIPATION);blit(velocity.write);velocity.swap();ext.supportLinearFiltering||gl.uniform2f(advectionProgram.uniforms.dyeTexelSize,dye.texelSizeX,dye.texelSizeY);gl.uniform1i(advectionProgram.uniforms.uVelocity,velocity.read.attach(0));gl.uniform1i(advectionProgram.uniforms.uSource,dye.read.attach(1));gl.uniform1f(advectionProgram.uniforms.dissipation,config.DENSITY_DISSIPATION);blit(dye.write);dye.swap()}
function render(a){config.BLOOM&&applyBloom(dye.read,bloom);config.SUNRAYS&&(applySunrays(dye.read,dye.write,sunrays),blur(sunrays,sunraysTemp,1));null!=a&&config.TRANSPARENT?gl.disable(gl.BLEND):(gl.blendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.enable(gl.BLEND));config.TRANSPARENT||drawColor(a,normalizeColor(config.BACK_COLOR));null==a&&config.TRANSPARENT&&drawCheckerboard(a);drawDisplay(a)}
function drawColor(a,b){colorProgram.bind();gl.uniform4f(colorProgram.uniforms.color,b.r,b.g,b.b,1);blit(a)}function drawCheckerboard(a){checkerboardProgram.bind();gl.uniform1f(checkerboardProgram.uniforms.aspectRatio,canvas.width/canvas.height);blit(a)}
function drawDisplay(a){var b=null==a?gl.drawingBufferWidth:a.width,c=null==a?gl.drawingBufferHeight:a.height;displayMaterial.bind();config.SHADING&&gl.uniform2f(displayMaterial.uniforms.texelSize,1/b,1/c);gl.uniform1i(displayMaterial.uniforms.uTexture,dye.read.attach(0));config.BLOOM&&(gl.uniform1i(displayMaterial.uniforms.uBloom,bloom.attach(1)),gl.uniform1i(displayMaterial.uniforms.uDithering,ditheringTexture.attach(2)),b=getTextureScale(ditheringTexture,b,c),gl.uniform2f(displayMaterial.uniforms.ditherScale,
b.x,b.y));config.SUNRAYS&&gl.uniform1i(displayMaterial.uniforms.uSunrays,sunrays.attach(3));blit(a)}
function applyBloom(a,b){if(!(2>bloomFramebuffers.length)){var c=b;gl.disable(gl.BLEND);bloomPrefilterProgram.bind();var d=config.BLOOM_THRESHOLD*config.BLOOM_SOFT_KNEE+1E-4;gl.uniform3f(bloomPrefilterProgram.uniforms.curve,config.BLOOM_THRESHOLD-d,2*d,.25/d);gl.uniform1f(bloomPrefilterProgram.uniforms.threshold,config.BLOOM_THRESHOLD);gl.uniform1i(bloomPrefilterProgram.uniforms.uTexture,a.attach(0));blit(c);bloomBlurProgram.bind();for(d=0;d<bloomFramebuffers.length;d++){var e=bloomFramebuffers[d];
gl.uniform2f(bloomBlurProgram.uniforms.texelSize,c.texelSizeX,c.texelSizeY);gl.uniform1i(bloomBlurProgram.uniforms.uTexture,c.attach(0));blit(e);c=e}gl.blendFunc(gl.ONE,gl.ONE);gl.enable(gl.BLEND);for(d=bloomFramebuffers.length-2;0<=d;d--)e=bloomFramebuffers[d],gl.uniform2f(bloomBlurProgram.uniforms.texelSize,c.texelSizeX,c.texelSizeY),gl.uniform1i(bloomBlurProgram.uniforms.uTexture,c.attach(0)),gl.viewport(0,0,e.width,e.height),blit(e),c=e;gl.disable(gl.BLEND);bloomFinalProgram.bind();gl.uniform2f(bloomFinalProgram.uniforms.texelSize,
c.texelSizeX,c.texelSizeY);gl.uniform1i(bloomFinalProgram.uniforms.uTexture,c.attach(0));gl.uniform1f(bloomFinalProgram.uniforms.intensity,config.BLOOM_INTENSITY);blit(b)}}function applySunrays(a,b,c){gl.disable(gl.BLEND);sunraysMaskProgram.bind();gl.uniform1i(sunraysMaskProgram.uniforms.uTexture,a.attach(0));blit(b);sunraysProgram.bind();gl.uniform1f(sunraysProgram.uniforms.weight,config.SUNRAYS_WEIGHT);gl.uniform1i(sunraysProgram.uniforms.uTexture,b.attach(0));blit(c)}
function blur(a,b,c){blurProgram.bind();for(var d=0;d<c;d++)gl.uniform2f(blurProgram.uniforms.texelSize,a.texelSizeX,0),gl.uniform1i(blurProgram.uniforms.uTexture,a.attach(0)),blit(b),gl.uniform2f(blurProgram.uniforms.texelSize,0,a.texelSizeY),gl.uniform1i(blurProgram.uniforms.uTexture,b.attach(0)),blit(a)}function splatPointer(a){splat(a.texcoordX,a.texcoordY,a.deltaX*config.SPLAT_FORCE,a.deltaY*config.SPLAT_FORCE,a.color)}
function multipleSplats(a){for(var b=0;b<a;b++){var c=generateColor();c.r*=10;c.g*=10;c.b*=10;splat(Math.random(),Math.random(),1E3*(Math.random()-.5),1E3*(Math.random()-.5),c)}}
function splat(a,b,c,d,e){splatProgram.bind();gl.uniform1i(splatProgram.uniforms.uTarget,velocity.read.attach(0));gl.uniform1f(splatProgram.uniforms.aspectRatio,canvas.width/canvas.height);gl.uniform2f(splatProgram.uniforms.point,a,b);gl.uniform3f(splatProgram.uniforms.color,c,d,0);gl.uniform1f(splatProgram.uniforms.radius,correctRadius(config.SPLAT_RADIUS/100));blit(velocity.write);velocity.swap();gl.uniform1i(splatProgram.uniforms.uTarget,dye.read.attach(0));gl.uniform3f(splatProgram.uniforms.color,
e.r,e.g,e.b);blit(dye.write);dye.swap()}function correctRadius(a){var b=canvas.width/canvas.height;1<b&&(a*=b);return a}canvas.addEventListener("mousedown",function(a){var b=scaleByPixelRatio(a.offsetX);a=scaleByPixelRatio(a.offsetY);var c=pointers.find(function(d){return-1==d.id});null==c&&(c=new pointerPrototype);updatePointerDownData(c,-1,b,a)});
canvas.addEventListener("mousemove",function(a){var b=pointers[0];if(b.down){var c=scaleByPixelRatio(a.offsetX);a=scaleByPixelRatio(a.offsetY);updatePointerMoveData(b,c,a)}});window.addEventListener("mouseup",function(){updatePointerUpData(pointers[0])});
canvas.addEventListener("touchstart",function(a){a.preventDefault();for(a=a.targetTouches;a.length>=pointers.length;)pointers.push(new pointerPrototype);for(var b=0;b<a.length;b++){var c=scaleByPixelRatio(a[b].pageX),d=scaleByPixelRatio(a[b].pageY);updatePointerDownData(pointers[b+1],a[b].identifier,c,d)}});
canvas.addEventListener("touchmove",function(a){a.preventDefault();a=a.targetTouches;for(var b=0;b<a.length;b++){var c=pointers[b+1];if(c.down){var d=scaleByPixelRatio(a[b].pageX),e=scaleByPixelRatio(a[b].pageY);updatePointerMoveData(c,d,e)}}},!1);
window.addEventListener("touchend",function(a){var b=a.changedTouches;for(a={i$jscomp$14:0};a.i$jscomp$14<b.length;a={i$jscomp$14:a.i$jscomp$14},a.i$jscomp$14++){var c=pointers.find(function(d){return function(e){return e.id==b[d.i$jscomp$14].identifier}}(a));null!=c&&updatePointerUpData(c)}});window.addEventListener("keydown",function(a){"KeyP"===a.code&&(config.PAUSED=!config.PAUSED);" "===a.key&&splatStack.push(parseInt(20*Math.random())+5)});
function updatePointerDownData(a,b,c,d){a.id=b;a.down=!0;a.moved=!1;a.texcoordX=c/canvas.width;a.texcoordY=1-d/canvas.height;a.prevTexcoordX=a.texcoordX;a.prevTexcoordY=a.texcoordY;a.deltaX=0;a.deltaY=0;a.color=generateColor()}
function updatePointerMoveData(a,b,c){a.prevTexcoordX=a.texcoordX;a.prevTexcoordY=a.texcoordY;a.texcoordX=b/canvas.width;a.texcoordY=1-c/canvas.height;a.deltaX=correctDeltaX(a.texcoordX-a.prevTexcoordX);a.deltaY=correctDeltaY(a.texcoordY-a.prevTexcoordY);a.moved=0<Math.abs(a.deltaX)||0<Math.abs(a.deltaY)}function updatePointerUpData(a){a.down=!1}function correctDeltaX(a){var b=canvas.width/canvas.height;1>b&&(a*=b);return a}
function correctDeltaY(a){var b=canvas.width/canvas.height;1<b&&(a/=b);return a}function generateColor(){var a=HSVtoRGB(Math.random(),1,1);a.r*=.15;a.g*=.15;a.b*=.15;return a}function HSVtoRGB(a,b,c){var d=Math.floor(6*a);var e=6*a-d;a=c*(1-b);var g=c*(1-e*b);b=c*(1-(1-e)*b);switch(d%6){case 0:var f=c;var h=b;var k=a;break;case 1:f=g;h=c;k=a;break;case 2:f=a;h=c;k=b;break;case 3:f=a;h=g;k=c;break;case 4:f=b;h=a;k=c;break;case 5:f=c,h=a,k=g}return{r:f,g:h,b:k}}
function normalizeColor(a){return{r:a.r/255,g:a.g/255,b:a.b/255}}function wrap(a,b,c){c-=b;return 0==c?b:(a-b)%c+b}function getResolution(a){var b=gl.drawingBufferWidth/gl.drawingBufferHeight;1>b&&(b=1/b);var c=Math.round(a);a=Math.round(a*b);return gl.drawingBufferWidth>gl.drawingBufferHeight?{width:a,height:c}:{width:c,height:a}}function getTextureScale(a,b,c){return{x:b/a.width,y:c/a.height}}function scaleByPixelRatio(a){return Math.floor(a*(window.devicePixelRatio||1))}
function hashCode(a){if(0==a.length)return 0;for(var b=0,c=0;c<a.length;c++)b=(b<<5)-b+a.charCodeAt(c),b|=0;return b};
'>